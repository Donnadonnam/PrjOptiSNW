---
title: |
  | Optimal Feasible Threshold Allocation
  | Conditional on Income, Marital Status and Kids Count
  | Given Marriage/Kids Group Specific Check Bounds
  | moredense_a100zh266_e2m2 vs moredense_a65zh266zs5_e2m2
  | ybin = 2500
output:
  html_notebook:
    toc: yes
    toc_depth: 4
  html_document:
    toc: yes
    toc_depth: '4'
    df_print: paged
---

```{r setup, include=FALSE}
# rm(list = ls())

knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(fig.width=12, fig.height=8)

library(tidyverse)
library(REconTools)
```

# Optimal Feasible Allocation

Given the maximum allocation for each of the 10 types of households: 2019 Income, Kids Count and Martial Status (non-stochastic) based optimal linear allocation (Utilitarian). Will solve for feasible optimal allocation results given different simulation structures.

1. Simulate without spousal productivity shocks
2. Simulate with spousal productivity shocks

Common Graph Title First Line Prefix

```{r}
slb_add_title_round1 = 'Round One Policy, '
slb_add_title_round2 = 'Round Two Policy, '
slb_subtitle_stack_2nd = 'optimal2nd_total = 1st actual + 2nd round optimal (given 1st actual) '
slb_subtitle_joint_1st2nd = 'optimal 1st and 2nd rounds (given 1st actual) '
```

Files:

```{r}
# # File Names
# st_file_type_nospouse_shock <- 'moredense_ybin25000'
# snm_simu_csv_nospouse_shock <- paste0('snwx_v_planner_',st_file_type_nospouse_shock,'.csv')
# st_file_type_withspouse_shock <- 'moredense_ybin25000'
# snm_simu_csv_withspouse_shock <- paste0('snwx_v_planner_',st_file_type_withspouse_shock,'.csv')

# # File Names
# st_file_type_nospouse_shock <- 'dense_ybin2500'
# snm_simu_csv_nospouse_shock <- paste0('snwx_v_planner_',st_file_type_nospouse_shock,'.csv')
# st_file_type_withspouse_shock <- 'dense_ybin2500'
# snm_simu_csv_withspouse_shock <- paste0('snwx_v_planner_',st_file_type_withspouse_shock,'.csv')

# File Names
st_file_type_nospouse_shock <- 'moredense_a100zh266_e2m2'
snm_simu_csv_nospouse_shock <- paste0('snwx_v_planner_',st_file_type_nospouse_shock,'.csv')
# st_file_type_withspouse_shock <- 'moredense_a100zh81zs5_e2m2'
# st_file_type_withspouse_shock <- 'moredense_a65zh133zs5_e2m2'
st_file_type_withspouse_shock <- 'moredense_a65zh266zs5_e2m2'
snm_simu_csv_withspouse_shock <- paste0('snwx_v_planner_',st_file_type_withspouse_shock,'.csv')
```


## Common Parameters Across

```{r}
bl_threshold = TRUE
# Max Phase Out given 1200*2 + 500*4 = 4400
fl_max_phaseout = 238000
it_bin_dollar_before_phaseout = 2500
# Dollar Per Check
fl_percheck_dollar = 100
# Meaning of Ymin Ymax simulated interval of 1
fl_multiple = 58056
# Number of Max Checks
it_max_checks_1st = 44
it_max_checks_2nd = 88
# Number of Tax Paying Households
fl_tax_hh = 128580000
# Number of Income Groups to Use: use 25 for 10,000 = 1
# Age Conditions
# it_max_age = 64
# it_min_age = 64
it_max_age = 64
it_min_age = 18
it_age_bins = 1
# Image Save Suffix
st_img_suf_age_ybin <- paste0(it_min_age, 't', it_max_age)
```

### Variable Names and Paths

```{r}
# File Path
srt_simu_path <- 'C:/Users/fan/Documents/Dropbox (UH-ECON)/PrjNygaardSorensenWang/Output/'

# Column Names
ar_svr_csv <- c('age', 'marital', 'kids', 'checks',	'ymin', 'mass', 'survive', 'vtilde', 'ctilde')
# Variables That Identify Individual Types
ar_svr_groups <- c('marital', 'kids', 'age_group', 'ymin_group')
ar_svr_groups_stats <- c('mass', 'survive')
# Number of Checks and Planner Value
svr_checks <- 'checks'
svr_v_value <- 'vtilde'
svr_c_value <- 'ctilde'
```

Image and Save Control

```{r}
# Images to Save
ls_st_save_imgs = c('mass', 'mc', 'checks_c', 'mv', 'checks_v')
# Save Folder
bl_save_img <- TRUE
spt_img_save='C:/Users/fan/Documents/Dropbox (UH-ECON)/PrjNygaardSorensenWang/Results/2020-07-29/Graphs/'
spt_img_save_nospouse_shock = paste0(spt_img_save, st_file_type_nospouse_shock, '/',
                                     'ybin', it_bin_dollar_before_phaseout, '/')
spt_img_save_withspouse_shock = paste0(spt_img_save, st_file_type_withspouse_shock,'/',
                                       'ybin', it_bin_dollar_before_phaseout, '/')
dir.create(file.path(spt_img_save_nospouse_shock), showWarnings = FALSE, recursive = TRUE)
dir.create(file.path(spt_img_save_withspouse_shock), showWarnings = FALSE, recursive = TRUE)
# Save Size
it_img_width=300
it_img_height=180
st_img_units='mm'
it_img_res=300
it_img_pointsize=3
```


### Planner Preference

```{r}
ar_rho <- 1 - (10^(c(seq(-2,2, length.out=8))))
ar_rho <- unique(ar_rho)
ar_rho <- c(1)
```

## Round 1 Results without Spousal Income Shocks

### Process

Call the input processing function

```{r}
# Call function
ls_prc_outputs_zs0_1st <- PrjOptiAlloc::ffp_snw_process_inputs(
  srt_simu_path = srt_simu_path,
  snm_simu_csv = snm_simu_csv_nospouse_shock,
  fl_max_phaseout = fl_max_phaseout,
  it_bin_dollar_before_phaseout = it_bin_dollar_before_phaseout,
  fl_percheck_dollar = fl_percheck_dollar,
  fl_multiple = fl_multiple,
  it_max_checks = it_max_checks_1st,
  fl_tax_hh = fl_tax_hh,
  it_max_age = it_max_age,
  it_min_age = it_min_age,
  it_age_bins = it_age_bins,
  ar_svr_csv = ar_svr_csv,
  ar_svr_groups = ar_svr_groups,
  ar_svr_groups_stats = ar_svr_groups_stats,
  svr_checks = svr_checks,
  svr_v_value = svr_v_value,
  svr_c_value = svr_c_value,
  ar_rho = ar_rho,
  bl_threshold = bl_threshold,
  bl_non_inc_adjust = FALSE,
  bl_print = FALSE,
  bl_print_verbose = FALSE)
```

### Outputs

```{r}
df_input_il_noninc_covar_zs0_1st=ls_prc_outputs_zs0_1st$df_input_il_noninc_covar
df_alloc_i_long_covar_c_zs0_1st=ls_prc_outputs_zs0_1st$df_alloc_i_long_covar_c
df_alloc_i_long_covar_v_zs0_1st=ls_prc_outputs_zs0_1st$df_alloc_i_long_covar_v
stg_subtitle=ls_prc_outputs_zs0_1st$stg_subtitle
stg_caption=ls_prc_outputs_zs0_1st$stg_caption
```

### Graphs

```{r}
# Generic non feasible specific Figures
st_img_suffix <- paste0(st_file_type_nospouse_shock, '_', st_img_suf_age_ybin, '_round1_feasible_threshold')
ls_pl_generic <- PrjOptiAlloc::ffp_snw_graph_feasible(ar_rho=ar_rho,
                                df_input_il_noninc_covar=df_input_il_noninc_covar_zs0_1st,
                                df_alloc_i_long_covar_c=df_alloc_i_long_covar_c_zs0_1st,
                                df_alloc_i_long_covar_v=df_alloc_i_long_covar_v_zs0_1st,
                                ls_st_save_imgs = c('mass', 'mc', 'mv'),
                                st_file_type = st_file_type_nospouse_shock,
                                slb_add_title = slb_add_title_round1,
                                stg_subtitle=stg_subtitle, stg_caption=stg_caption,
															  st_img_suffix=st_img_suffix, bl_save_img=bl_save_img,
                                it_img_width=it_img_width, it_img_height=it_img_height,
                                st_img_units='mm', it_img_res=it_img_res, it_img_pointsize=it_img_pointsize,
															  spt_img_save=spt_img_save_nospouse_shock)
# Generate Graphs
st_img_suffix <- paste0(st_file_type_nospouse_shock, '_', st_img_suf_age_ybin, '_round1_feasible_threshold')
ls_pl <- PrjOptiAlloc::ffp_snw_graph_feasible(ar_rho=ar_rho,
                                df_input_il_noninc_covar=df_input_il_noninc_covar_zs0_1st,
                                df_alloc_i_long_covar_c=df_alloc_i_long_covar_c_zs0_1st,
                                df_alloc_i_long_covar_v=df_alloc_i_long_covar_v_zs0_1st,
                                ls_st_save_imgs = c('checks_c', 'checks_v'),
                                st_file_type = st_file_type_nospouse_shock,
                                slb_add_title = slb_add_title_round1,
                                stg_subtitle=stg_subtitle, stg_caption=stg_caption,
															  st_img_suffix=st_img_suffix, bl_save_img=bl_save_img,
                                it_img_width=it_img_width, it_img_height=it_img_height,
                                st_img_units='mm', it_img_res=it_img_res, it_img_pointsize=it_img_pointsize,
															  spt_img_save=spt_img_save_nospouse_shock)
```

#### Mass

```{r}
# Print Graphs
print(ls_pl_generic$mass)
```

#### MPC

```{r}
print(ls_pl_generic$mc)
```

#### Opti C

```{r}
print(ls_pl$checks_c)
```

#### MV

```{r}
print(ls_pl_generic$mv)
```

#### Opti V

```{r}
print(ls_pl$checks_v)
```

## Round 1 Results with Spousal Income Shocks

### Process

Call the input processing function

```{r}
# Call function
ls_prc_outputs_zs5_1st <- PrjOptiAlloc::ffp_snw_process_inputs(
  srt_simu_path = srt_simu_path,
  snm_simu_csv = snm_simu_csv_withspouse_shock,
  fl_max_phaseout = fl_max_phaseout,
  it_bin_dollar_before_phaseout = it_bin_dollar_before_phaseout,
  fl_percheck_dollar = fl_percheck_dollar,
  fl_multiple = fl_multiple,
  it_max_checks = it_max_checks_1st,
  fl_tax_hh = fl_tax_hh,
  it_max_age = it_max_age,
  it_min_age = it_min_age,
  it_age_bins = it_age_bins,
  ar_svr_csv = ar_svr_csv,
  ar_svr_groups = ar_svr_groups,
  ar_svr_groups_stats = ar_svr_groups_stats,
  svr_checks = svr_checks,
  svr_v_value = svr_v_value,
  svr_c_value = svr_c_value,
  ar_rho = ar_rho,
  bl_threshold = bl_threshold,
  bl_non_inc_adjust = TRUE,
  bl_print = FALSE,
  bl_print_verbose = FALSE)
```

### Outputs

REV:

```{r}
tb_rho_rev_c=ls_prc_outputs_zs5_1st$tb_rho_rev_c
tb_rho_rev_v=ls_prc_outputs_zs5_1st$tb_rho_rev_v
print(tb_rho_rev_c)
print(tb_rho_rev_v)
```

Allocation Results:

```{r}
df_input_il_noninc_covar_zs5_1st=ls_prc_outputs_zs5_1st$df_input_il_noninc_covar
df_alloc_i_long_covar_c_zs5_1st=ls_prc_outputs_zs5_1st$df_alloc_i_long_covar_c
df_alloc_i_long_covar_v_zs5_1st=ls_prc_outputs_zs5_1st$df_alloc_i_long_covar_v
```

Graph related:

```{r}
stg_subtitle=ls_prc_outputs_zs5_1st$stg_subtitle
stg_caption=ls_prc_outputs_zs5_1st$stg_caption
```

### Graphs

```{r}
# Generic non feasible specific Figures
st_img_suffix <- paste0(st_file_type_withspouse_shock, '_', st_img_suf_age_ybin, '_round1_feasible_threshold')
ls_pl_generic <- PrjOptiAlloc::ffp_snw_graph_feasible(ar_rho=ar_rho,
                                df_input_il_noninc_covar=df_input_il_noninc_covar_zs5_1st,
                                df_alloc_i_long_covar_c=df_alloc_i_long_covar_c_zs5_1st,
                                df_alloc_i_long_covar_v=df_alloc_i_long_covar_v_zs5_1st,
                                ls_st_save_imgs = c('mass', 'mc', 'mv'),
                                st_file_type = st_file_type_withspouse_shock,
                                slb_add_title = slb_add_title_round1,
                                stg_subtitle=stg_subtitle, stg_caption=stg_caption,
                                it_img_width=it_img_width, it_img_height=it_img_height,
                                st_img_units='mm', it_img_res=it_img_res, it_img_pointsize=it_img_pointsize,
															  st_img_suffix=st_img_suffix, bl_save_img=bl_save_img,
															  spt_img_save=spt_img_save_withspouse_shock)
# Generate Graphs
st_img_suffix <- paste0(st_file_type_withspouse_shock, '_', st_img_suf_age_ybin, '_round1_feasible_threshold')
ls_pl <- PrjOptiAlloc::ffp_snw_graph_feasible(ar_rho=ar_rho,
                                df_input_il_noninc_covar=df_input_il_noninc_covar_zs5_1st,
                                df_alloc_i_long_covar_c=df_alloc_i_long_covar_c_zs5_1st,
                                df_alloc_i_long_covar_v=df_alloc_i_long_covar_v_zs5_1st,
                                ls_st_save_imgs = c('checks_c', 'checks_v'),
                                st_file_type = st_file_type_withspouse_shock,
                                slb_add_title = slb_add_title_round1,
                                stg_subtitle=stg_subtitle, stg_caption=stg_caption,
                                it_img_width=it_img_width, it_img_height=it_img_height,
                                st_img_units='mm', it_img_res=it_img_res, it_img_pointsize=it_img_pointsize,
															  st_img_suffix=st_img_suffix, bl_save_img=bl_save_img,
															  spt_img_save=spt_img_save_withspouse_shock)
```

#### Mass

```{r}
# Print Graphs
print(ls_pl$mass)
```

#### MPC

```{r}
print(ls_pl$mc)
```

#### Opti C

```{r}
print(ls_pl$checks_c)
```

#### MV

```{r}
print(ls_pl$mv)
```

#### Opti V

```{r}
print(ls_pl$checks_v)
```

## Round 2 Results without Spousal Income Shocks

```{r}
bl_given_firstcheck <- TRUE
```

### Process

Call the input processing function

```{r}
# Call function
ls_prc_outputs_zs0_2nd <- PrjOptiAlloc::ffp_snw_process_inputs(
  srt_simu_path = srt_simu_path,
  snm_simu_csv = snm_simu_csv_nospouse_shock,
  fl_max_phaseout = fl_max_phaseout,
  it_bin_dollar_before_phaseout = it_bin_dollar_before_phaseout,
  fl_percheck_dollar = fl_percheck_dollar,
  fl_multiple = fl_multiple,
  it_max_checks = it_max_checks_2nd,
  fl_tax_hh = fl_tax_hh,
  it_max_age = it_max_age,
  it_min_age = it_min_age,
  it_age_bins = it_age_bins,
  ar_svr_csv = ar_svr_csv,
  ar_svr_groups = ar_svr_groups,
  ar_svr_groups_stats = ar_svr_groups_stats,
  svr_checks = svr_checks,
  svr_v_value = svr_v_value,
  svr_c_value = svr_c_value,
  ar_rho = ar_rho,
  bl_given_firstcheck = bl_given_firstcheck,
  bl_threshold = bl_threshold,
  bl_non_inc_adjust = FALSE,
  bl_print = FALSE,
  bl_print_verbose = FALSE)
```

### Outputs

```{r}
df_input_il_noninc_covar_zs0_2nd=ls_prc_outputs_zs0_2nd$df_input_il_noninc_covar
df_alloc_i_long_covar_c_zs0_2nd=ls_prc_outputs_zs0_2nd$df_alloc_i_long_covar_c
df_alloc_i_long_covar_v_zs0_2nd=ls_prc_outputs_zs0_2nd$df_alloc_i_long_covar_v
stg_subtitle=ls_prc_outputs_zs0_2nd$stg_subtitle
stg_caption=ls_prc_outputs_zs0_2nd$stg_caption
```

### Graphs

#### Graph Round Two MV and MC

```{r}
# Generate Graphs
stg_subtitle_stack=paste0(slb_subtitle_stack_2nd, stg_subtitle)
st_img_suffix <- paste0(st_file_type_nospouse_shock, '_', st_img_suf_age_ybin, '_round2_feasible_threshold')
ls_pl_r2 <- PrjOptiAlloc::ffp_snw_graph_feasible(ar_rho=ar_rho,
                                df_input_il_noninc_covar=df_input_il_noninc_covar_zs0_2nd,
                                df_alloc_i_long_covar_c=df_alloc_i_long_covar_c_zs0_2nd,
                                df_alloc_i_long_covar_v=df_alloc_i_long_covar_v_zs0_2nd,
                                ls_st_save_imgs = c('mv', 'mc'),
                                st_file_type = st_file_type_nospouse_shock,
                                slb_add_title = slb_add_title_round2,
                                stg_subtitle=stg_subtitle_stack, stg_caption=stg_caption,
                                it_img_width=it_img_width, it_img_height=it_img_height,
                                st_img_units='mm', it_img_res=it_img_res, it_img_pointsize=it_img_pointsize,
															  st_img_suffix=st_img_suffix, bl_save_img=bl_save_img,
															  spt_img_save=spt_img_save_nospouse_shock)

```

#### Graph Round One actual + Round Two Optimal

```{r}
# Update Consumption Frame
df_alloc_i_long_covar_c_zs0_2nd_stack <- df_alloc_i_long_covar_c_zs0_2nd %>%
  group_by(rho, id_i) %>%
  pivot_wider(names_from = allocate_type,
              values_from = checks) %>%
  mutate(total = optimal + actual) %>%
  rename(checks_optimal = optimal,
         checks_actual = actual,
         checks_opti2nd_total = total) %>%
  pivot_longer(cols = starts_with('checks'),
               names_to = c('allocate_type'),
               names_pattern = paste0("checks_(.*)"),
               values_to = "checks") %>%
  filter(allocate_type != 'optimal')
# Update Value Frame
df_alloc_i_long_covar_v_zs0_2nd_stack <- df_alloc_i_long_covar_v_zs0_2nd %>%
  group_by(rho, id_i) %>%
  pivot_wider(names_from = allocate_type,
              values_from = checks) %>%
  mutate(total = optimal + actual) %>%
  rename(checks_optimal = optimal,
         checks_actual = actual,
         checks_optimal2nd_total = total) %>%
  pivot_longer(cols = starts_with('checks'),
               names_to = c('allocate_type'),
               names_pattern = paste0("checks_(.*)"),
               values_to = "checks") %>%
  filter(allocate_type != 'optimal')
# Generate Graphs
stg_subtitle_stack=paste0(slb_subtitle_stack_2nd, stg_subtitle)
st_img_suffix <- paste0(st_file_type_nospouse_shock, '_', st_img_suf_age_ybin, '_round2_feasible_threshold_stack')
ls_pl_stack <- PrjOptiAlloc::ffp_snw_graph_feasible(ar_rho=ar_rho,
                                df_input_il_noninc_covar=df_input_il_noninc_covar_zs0_2nd,
                                df_alloc_i_long_covar_c=df_alloc_i_long_covar_c_zs0_2nd_stack,
                                df_alloc_i_long_covar_v=df_alloc_i_long_covar_v_zs0_2nd_stack,
                                ls_st_save_imgs = c('checks_c', 'checks_v'),
                                st_file_type = st_file_type_nospouse_shock,
                                slb_add_title = slb_add_title_round2,
                                stg_subtitle=stg_subtitle_stack, stg_caption=stg_caption,
                                it_img_width=it_img_width, it_img_height=it_img_height,
                                st_img_units='mm', it_img_res=it_img_res, it_img_pointsize=it_img_pointsize,
															  st_img_suffix=st_img_suffix, bl_save_img=bl_save_img,
															  spt_img_save=spt_img_save_nospouse_shock)
```

#### Graph Compare Round 1 and 2 Optimal

```{r}
# Update Consumption Frame
df_alloc_i_long_covar_c_zs0_2nd_joint <- df_alloc_i_long_covar_c_zs0_2nd %>%
  group_by(rho, id_i) %>%
  pivot_wider(names_from = allocate_type,
              values_from = checks) %>%
  rename(optimal_2nd_round = optimal) %>%
  left_join(df_alloc_i_long_covar_c_zs0_1st %>%
              filter( allocate_type == 'optimal') %>%
              select(id_i, rho, checks) %>%
              rename(optimal_1st_round = checks),
            by=setNames(c('id_i', 'rho'), c('id_i', 'rho'))) %>%
  select(-actual) %>%
  pivot_longer(cols = starts_with('optimal'),
               names_to = c('allocate_type'),
               names_pattern = paste0("optimal_(.*)"),
               values_to = "checks")
# Update Value Frame
df_alloc_i_long_covar_v_zs0_2nd_joint <- df_alloc_i_long_covar_v_zs0_2nd %>%
  group_by(rho, id_i) %>%
  pivot_wider(names_from = allocate_type,
              values_from = checks) %>%
  rename(optimal_2nd_round = optimal) %>%
  left_join(df_alloc_i_long_covar_v_zs0_1st %>%
              filter( allocate_type == 'optimal') %>%
              select(id_i, rho, checks) %>%
              rename(optimal_1st_round = checks),
            by=setNames(c('id_i', 'rho'), c('id_i', 'rho'))) %>%
  select(-actual) %>%
  pivot_longer(cols = starts_with('optimal'),
               names_to = c('allocate_type'),
               names_pattern = paste0("optimal_(.*)"),
               values_to = "checks")
# Generate Graphs
stg_subtitle_joint=paste0(slb_subtitle_joint_1st2nd, stg_subtitle)
st_img_suffix <- paste0(st_file_type_nospouse_shock, '_', st_img_suf_age_ybin, '_round2_feasible_threshold_joint')
ls_pl_joint <- PrjOptiAlloc::ffp_snw_graph_feasible(ar_rho=ar_rho,
                                df_input_il_noninc_covar=df_input_il_noninc_covar_zs0_2nd,
                                df_alloc_i_long_covar_c=df_alloc_i_long_covar_c_zs0_2nd_joint,
                                df_alloc_i_long_covar_v=df_alloc_i_long_covar_v_zs0_2nd_joint,
                                ls_st_save_imgs = c('checks_c', 'checks_v'),
                                st_file_type = st_file_type_nospouse_shock,
                                slb_add_title = slb_add_title_round2,
                                stg_subtitle=stg_subtitle_joint, stg_caption=stg_caption,
                                it_img_width=it_img_width, it_img_height=it_img_height,
                                st_img_units='mm', it_img_res=it_img_res, it_img_pointsize=it_img_pointsize,
															  st_img_suffix=st_img_suffix, bl_save_img=bl_save_img,
															  spt_img_save=spt_img_save_nospouse_shock)
```


#### MPC Round 2

Given the number of checks individuals received in the first round, what is the Marginal Consumption from successive checks?

```{r}
print(ls_pl_stack$mc)
```

#### Opti C, 1st Actual + 2nd Optimal

```{r}
print(ls_pl_stack$checks_c)
```

#### Opti C, 1st Optimal cvs 2nd Optimal

```{r}
print(ls_pl_joint$checks_c)
```

#### MV Round 2

```{r}
print(ls_pl_stack$mv)
```

#### Opti V, 1st Actual + 2nd Optimal

```{r}
print(ls_pl_stack$checks_v)
```

#### Opti V, 1st Optimal cvs 2nd Optimal

```{r}
print(ls_pl_joint$checks_v)
```

## Round 2 Results with Spousal Income Shocks

```{r}
bl_given_firstcheck <- TRUE
```

### Process

Call the input processing function

```{r}
# Call function
ls_prc_outputs_zs5_2nd <- PrjOptiAlloc::ffp_snw_process_inputs(
  srt_simu_path = srt_simu_path,
  snm_simu_csv = snm_simu_csv_withspouse_shock,
  fl_max_phaseout = fl_max_phaseout,
  it_bin_dollar_before_phaseout = it_bin_dollar_before_phaseout,
  fl_percheck_dollar = fl_percheck_dollar,
  fl_multiple = fl_multiple,
  it_max_checks = it_max_checks_2nd,
  fl_tax_hh = fl_tax_hh,
  it_max_age = it_max_age,
  it_min_age = it_min_age,
  it_age_bins = it_age_bins,
  ar_svr_csv = ar_svr_csv,
  ar_svr_groups = ar_svr_groups,
  ar_svr_groups_stats = ar_svr_groups_stats,
  svr_checks = svr_checks,
  svr_v_value = svr_v_value,
  svr_c_value = svr_c_value,
  ar_rho = ar_rho,
  bl_given_firstcheck = bl_given_firstcheck,
  bl_threshold = bl_threshold,
  bl_non_inc_adjust = FALSE,
  bl_print = FALSE,
  bl_print_verbose = FALSE)
```

### Outputs

```{r}
df_input_il_noninc_covar_zs5_2nd=ls_prc_outputs_zs5_2nd$df_input_il_noninc_covar
df_alloc_i_long_covar_c_zs5_2nd=ls_prc_outputs_zs5_2nd$df_alloc_i_long_covar_c
df_alloc_i_long_covar_v_zs5_2nd=ls_prc_outputs_zs5_2nd$df_alloc_i_long_covar_v
stg_subtitle=ls_prc_outputs_zs5_2nd$stg_subtitle
stg_caption=ls_prc_outputs_zs5_2nd$stg_caption
```

### Graphs

#### Graph Round Two MV and MC

```{r}
# Generate Graphs
stg_subtitle_stack=paste0(slb_subtitle_stack_2nd, stg_subtitle)
st_img_suffix <- paste0(st_file_type_withspouse_shock, '_', st_img_suf_age_ybin, '_round2_feasible_threshold')
ls_pl_r2 <- PrjOptiAlloc::ffp_snw_graph_feasible(ar_rho=ar_rho,
                                df_input_il_noninc_covar=df_input_il_noninc_covar_zs5_2nd,
                                df_alloc_i_long_covar_c=df_alloc_i_long_covar_c_zs5_2nd,
                                df_alloc_i_long_covar_v=df_alloc_i_long_covar_v_zs5_2nd,
                                ls_st_save_imgs = c('mv', 'mc'),
                                st_file_type = st_file_type_withspouse_shock,
                                slb_add_title = slb_add_title_round2,
                                stg_subtitle=stg_subtitle_stack, stg_caption=stg_caption,
                                it_img_width=it_img_width, it_img_height=it_img_height,
                                st_img_units='mm', it_img_res=it_img_res, it_img_pointsize=it_img_pointsize,
															  st_img_suffix=st_img_suffix, bl_save_img=bl_save_img,
															  spt_img_save=spt_img_save_withspouse_shock)
```

#### Graph Round One actual + Round Two Optimal

```{r}
slb_subtitle_stack1st2nd = ''
# Update Consumption Frame
df_alloc_i_long_covar_c_zs5_2nd_stack <- df_alloc_i_long_covar_c_zs5_2nd %>%
  group_by(rho, id_i) %>%
  pivot_wider(names_from = allocate_type,
              values_from = checks) %>%
  mutate(total = optimal + actual) %>%
  rename(checks_optimal = optimal,
         checks_actual = actual,
         checks_opti2nd_total = total) %>%
  pivot_longer(cols = starts_with('checks'),
               names_to = c('allocate_type'),
               names_pattern = paste0("checks_(.*)"),
               values_to = "checks") %>%
  filter(allocate_type != 'optimal')
# Update Value Frame
df_alloc_i_long_covar_v_zs5_2nd_stack <- df_alloc_i_long_covar_v_zs5_2nd %>%
  group_by(rho, id_i) %>%
  pivot_wider(names_from = allocate_type,
              values_from = checks) %>%
  mutate(total = optimal + actual) %>%
  rename(checks_optimal = optimal,
         checks_actual = actual,
         checks_optimal2nd_total = total) %>%
  pivot_longer(cols = starts_with('checks'),
               names_to = c('allocate_type'),
               names_pattern = paste0("checks_(.*)"),
               values_to = "checks") %>%
  filter(allocate_type != 'optimal')
# Generate Graphs
stg_subtitle_stack=paste0(slb_subtitle_stack_2nd, stg_subtitle)
st_img_suffix <- paste0(st_file_type_withspouse_shock, '_', st_img_suf_age_ybin, '_round2_feasible_threshold_stack')
ls_pl_stack <- PrjOptiAlloc::ffp_snw_graph_feasible(ar_rho=ar_rho,
                                df_input_il_noninc_covar=df_input_il_noninc_covar_zs5_2nd,
                                df_alloc_i_long_covar_c=df_alloc_i_long_covar_c_zs5_2nd_stack,
                                df_alloc_i_long_covar_v=df_alloc_i_long_covar_v_zs5_2nd_stack,
                                ls_st_save_imgs = c('checks_c', 'checks_v'),
                                st_file_type = st_file_type_withspouse_shock,
                                slb_add_title = slb_add_title_round2,
                                stg_subtitle=stg_subtitle_stack, stg_caption=stg_caption,
                                it_img_width=it_img_width, it_img_height=it_img_height,
                                st_img_units='mm', it_img_res=it_img_res, it_img_pointsize=it_img_pointsize,
															  st_img_suffix=st_img_suffix, bl_save_img=bl_save_img,
															  spt_img_save=spt_img_save_withspouse_shock)
```

#### Graph Compare Round 1 and 2 Optimal

```{r}
# Update Consumption Frame
df_alloc_i_long_covar_c_zs5_2nd_joint <- df_alloc_i_long_covar_c_zs5_2nd %>%
  group_by(rho, id_i) %>%
  pivot_wider(names_from = allocate_type,
              values_from = checks) %>%
  rename(optimal_2nd_round = optimal) %>%
  left_join(df_alloc_i_long_covar_c_zs5_1st %>%
              filter( allocate_type == 'optimal') %>%
              select(id_i, rho, checks) %>%
              rename(optimal_1st_round = checks),
            by=setNames(c('id_i', 'rho'), c('id_i', 'rho'))) %>%
  select(-actual) %>%
  pivot_longer(cols = starts_with('optimal'),
               names_to = c('allocate_type'),
               names_pattern = paste0("optimal_(.*)"),
               values_to = "checks")
# Update Value Frame
df_alloc_i_long_covar_v_zs5_2nd_joint <- df_alloc_i_long_covar_v_zs5_2nd %>%
  group_by(rho, id_i) %>%
  pivot_wider(names_from = allocate_type,
              values_from = checks) %>%
  rename(optimal_2nd_round = optimal) %>%
  left_join(df_alloc_i_long_covar_v_zs5_1st %>%
              filter( allocate_type == 'optimal') %>%
              select(id_i, rho, checks) %>%
              rename(optimal_1st_round = checks),
            by=setNames(c('id_i', 'rho'), c('id_i', 'rho'))) %>%
  select(-actual) %>%
  pivot_longer(cols = starts_with('optimal'),
               names_to = c('allocate_type'),
               names_pattern = paste0("optimal_(.*)"),
               values_to = "checks")
# Generate Graphs
stg_subtitle_joint=paste0(slb_subtitle_joint_1st2nd, stg_subtitle)
st_img_suffix <- paste0(st_file_type_withspouse_shock, '_', st_img_suf_age_ybin, '_round2_feasible_threshold_joint')
ls_pl_joint <- PrjOptiAlloc::ffp_snw_graph_feasible(ar_rho=ar_rho,
                                df_input_il_noninc_covar=df_input_il_noninc_covar_zs5_2nd,
                                df_alloc_i_long_covar_c=df_alloc_i_long_covar_c_zs5_2nd_joint,
                                df_alloc_i_long_covar_v=df_alloc_i_long_covar_v_zs5_2nd_joint,
                                ls_st_save_imgs = c('checks_c', 'checks_v'),
                                st_file_type = st_file_type_withspouse_shock,
                                slb_add_title = slb_add_title_round2,
                                stg_subtitle=stg_subtitle_joint, stg_caption=stg_caption,
                                it_img_width=it_img_width, it_img_height=it_img_height,
                                st_img_units='mm', it_img_res=it_img_res, it_img_pointsize=it_img_pointsize,
															  st_img_suffix=st_img_suffix, bl_save_img=bl_save_img,
															  spt_img_save=spt_img_save_withspouse_shock)
```


#### MPC Round 2

Given the number of checks individuals received in the first round, what is the Marginal Consumption from successive checks?

```{r}
print(ls_pl_r2$mc)
```

#### Opti C, 1st Actual + 2nd Optimal

```{r}
print(ls_pl_stack$checks_c)
```

#### Opti C, 1st Optimal cvs 2nd Optimal

```{r}
print(ls_pl_joint$checks_c)
```

#### MV Round 2

```{r}
print(ls_pl_r2$mv)
```

#### Opti V, 1st Actual + 2nd Optimal

```{r}
print(ls_pl_stack$checks_v)
```

#### Opti V, 1st Optimal cvs 2nd Optimal

```{r}
print(ls_pl_joint$checks_v)
```


## Notes

"Sed ut perspiciatis unde omnis iste natus error sit voluptatem accusantium doloremque laudantium, totam rem aperiam, eaque ipsa quae ab illo inventore veritatis et quasi architecto beatae vitae dicta sunt explicabo. Nemo enim ipsam voluptatem quia voluptas sit aspernatur aut odit aut fugit, sed quia consequuntur magni dolores eos qui ratione voluptatem sequi nesciunt. Neque porro quisquam est, qui dolorem ipsum quia dolor sit amet, consectetur, adipisci velit, sed quia non numquam eius modi tempora incidunt ut labore et dolore magnam aliquam quaerat voluptatem. Ut enim ad minima veniam, quis nostrum exercitationem ullam corporis suscipit laboriosam, nisi ut aliquid ex ea commodi consequatur? Quis autem vel eum iure reprehenderit qui in ea voluptate velit esse quam nihil molestiae consequatur, vel illum qui dolorem eum fugiat quo voluptas nulla pariatur?"

"Sed ut perspiciatis unde omnis iste natus error sit voluptatem accusantium doloremque laudantium, totam rem aperiam, eaque ipsa quae ab illo inventore veritatis et quasi architecto beatae vitae dicta sunt explicabo. Nemo enim ipsam voluptatem quia voluptas sit aspernatur aut odit aut fugit, sed quia consequuntur magni dolores eos qui ratione voluptatem sequi nesciunt. Neque porro quisquam est, qui dolorem ipsum quia dolor sit amet, consectetur, adipisci velit, sed quia non numquam eius modi tempora incidunt ut labore et dolore magnam aliquam quaerat voluptatem. Ut enim ad minima veniam, quis nostrum exercitationem ullam corporis suscipit laboriosam, nisi ut aliquid ex ea commodi consequatur? Quis autem vel eum iure reprehenderit qui in ea voluptate velit esse quam nihil molestiae consequatur, vel illum qui dolorem eum fugiat quo voluptas nulla pariatur?"

"Sed ut perspiciatis unde omnis iste natus error sit voluptatem accusantium doloremque laudantium, totam rem aperiam, eaque ipsa quae ab illo inventore veritatis et quasi architecto beatae vitae dicta sunt explicabo. Nemo enim ipsam voluptatem quia voluptas sit aspernatur aut odit aut fugit, sed quia consequuntur magni dolores eos qui ratione voluptatem sequi nesciunt. Neque porro quisquam est, qui dolorem ipsum quia dolor sit amet, consectetur, adipisci velit, sed quia non numquam eius modi tempora incidunt ut labore et dolore magnam aliquam quaerat voluptatem. Ut enim ad minima veniam, quis nostrum exercitationem ullam corporis suscipit laboriosam, nisi ut aliquid ex ea commodi consequatur? Quis autem vel eum iure reprehenderit qui in ea voluptate velit esse quam nihil molestiae consequatur, vel illum qui dolorem eum fugiat quo voluptas nulla pariatur?"

"Sed ut perspiciatis unde omnis iste natus error sit voluptatem accusantium doloremque laudantium, totam rem aperiam, eaque ipsa quae ab illo inventore veritatis et quasi architecto beatae vitae dicta sunt explicabo. Nemo enim ipsam voluptatem quia voluptas sit aspernatur aut odit aut fugit, sed quia consequuntur magni dolores eos qui ratione voluptatem sequi nesciunt. Neque porro quisquam est, qui dolorem ipsum quia dolor sit amet, consectetur, adipisci velit, sed quia non numquam eius modi tempora incidunt ut labore et dolore magnam aliquam quaerat voluptatem. Ut enim ad minima veniam, quis nostrum exercitationem ullam corporis suscipit laboriosam, nisi ut aliquid ex ea commodi consequatur? Quis autem vel eum iure reprehenderit qui in ea voluptate velit esse quam nihil molestiae consequatur, vel illum qui dolorem eum fugiat quo voluptas nulla pariatur?"

"Sed ut perspiciatis unde omnis iste natus error sit voluptatem accusantium doloremque laudantium, totam rem aperiam, eaque ipsa quae ab illo inventore veritatis et quasi architecto beatae vitae dicta sunt explicabo. Nemo enim ipsam voluptatem quia voluptas sit aspernatur aut odit aut fugit, sed quia consequuntur magni dolores eos qui ratione voluptatem sequi nesciunt. Neque porro quisquam est, qui dolorem ipsum quia dolor sit amet, consectetur, adipisci velit, sed quia non numquam eius modi tempora incidunt ut labore et dolore magnam aliquam quaerat voluptatem. Ut enim ad minima veniam, quis nostrum exercitationem ullam corporis suscipit laboriosam, nisi ut aliquid ex ea commodi consequatur? Quis autem vel eum iure reprehenderit qui in ea voluptate velit esse quam nihil molestiae consequatur, vel illum qui dolorem eum fugiat quo voluptas nulla pariatur?"
